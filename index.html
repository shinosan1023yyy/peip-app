<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>P.E.I.P.æ„æ€æ±ºå®šæ”¯æ´ï¼ˆãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ï¼šå®šç¾©æº–æ‹ ç‰ˆï¼‰</title>
<style>
  :root { --bg:#fff; --fg:#222; --muted:#666; --line:#e6e6e6; --shadow:0 6px 28px rgba(0,0,0,.06); }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Sans","Noto Sans JP","Yu Gothic",sans-serif;}
  header{position:sticky;top:0;z-index:10;background:#f7f7f8;border-bottom:1px solid var(--line);padding:12px 16px}
  header h1{margin:0 0 6px 0;font-size:18px}
  header .note{font-size:12px;color:#444;line-height:1.6}
  main{max-width:1120px;margin:18px auto 100px;padding:0 16px}
  section{border:1px solid var(--line);border-radius:12px;padding:14px;margin:14px 0;background:#fff;box-shadow:var(--shadow)}
  h2{font-size:18px;margin:0 0 10px}
  summary{cursor:pointer}
  .grid{display:grid;gap:10px}
  .grid.cols-2{grid-template-columns:1fr 1fr}
  .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .right{margin-left:auto}
  .small{font-size:12px;color:#555}
  .muted{color:#666}
  .pill{padding:4px 8px;border:1px solid var(--line);border-radius:999px;background:#fafafa}
  .summary{display:flex;gap:10px;flex-wrap:wrap;font-size:14px;margin-bottom:6px}
  .ok{color:#1b5e20}
  .warn{color:#b00020}
  .btn{padding:8px 12px;border:1px solid #bbb;border-radius:8px;background:#f8f8f8;cursor:pointer}
  .btn:hover{background:#f0f0f0}
  .btn.primary{background:#222;color:#fff;border-color:#222}
  .btn.primary[disabled]{opacity:.45;cursor:not-allowed}
  input[type=text],input[type=date],select,textarea{width:100%;padding:8px;border:1px solid #ccc;border-radius:8px}
  textarea{min-height:160px}
  .row{display:grid;grid-template-columns:40px 1fr 168px 1.2fr auto auto;gap:8px;align-items:center;padding:6px 0;border-bottom:1px dashed #eee}
  .row:last-child{border-bottom:none}
  .idx{font:12px/1 monospace;color:#777;text-align:right}
  .reason{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .card{border:1px solid var(--line);border-radius:10px;padding:12px;background:#fff}
  ul{margin:6px 0 0 18px}
  .foot{position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:1px solid var(--line);padding:8px 16px}
  /* Modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;z-index:100}
  .modal .box{background:#fff;border-radius:12px;max-width:760px;width:calc(100% - 24px);padding:16px;border:1px solid var(--line);box-shadow:var(--shadow)}
  .modal h3{margin:0 0 6px 0;font-size:16px}
  .optlist{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:8px;margin:10px 0}
  .optlist button{padding:10px;border:1px solid #ccc;border-radius:8px;background:#fafafa;cursor:pointer}
  .optlist button:hover{background:#f1f1f1}
  .hint{font-size:12px;color:#666}
  details.help{background:#fcfcfd;border:1px dashed #d9d9d9}
  details.help > summary{padding:4px 0}
  details.help .helpbody{font-size:13px;color:#444;line-height:1.6}
  details.help .helpbody b{color:#000}
  code.k{background:#f5f5f5;border:1px solid #e2e2e2;border-radius:4px;padding:1px 4px}
</style>
</head>
<body>
<header>
  <h1>P.E.I.P.æ„æ€æ±ºå®šæ”¯æ´ï¼ˆãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ï¼šå®šç¾©æº–æ‹ ç‰ˆï¼‰</h1>
  <div class="note">
    ç›®çš„ï¼š<b>ä»‹è­·ç¦ç¥‰æ”¯æ´ã®è¨ˆç”»</b>ä½œæˆã®ãŸã‚ã®ã‚¢ãƒ—ãƒªã§ã™ï¼ˆåŒ»ç™‚ã®è¨ºæ–­ãƒ»æ²»ç™‚ãƒ»å‡¦æ–¹ã¯æ‰±ã„ã¾ã›ã‚“ï¼‰:contentReference[oaicite:8]{index=8}ã€‚  
    P.E.I.P.ï¼èµ¤ï¼šãã‚‚ã¡ï¼é’ï¼šã¾ã‚ã‚Šï¼é»„ï¼šã§ãã‚‹ã“ã¨ï¼ç·‘ï¼šã‹ã‚‰ã ï¼ˆåˆ†é¡ã¯ä¸€æ–‡ä¸€è‰²ãƒ»ä¸­å¿ƒä¸»é¡Œï¼‰:contentReference[oaicite:9]{index=9}ã€‚  
    è¡¨æƒ…èªã¯<strong>åˆæœŸ=ç·‘</strong>ã€æœ¬äººç™ºè¨€ãŒã‚ã‚‹å ´åˆã®ã¿èµ¤ã¸åˆ‡æ›¿ï¼ˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ï¼‰:contentReference[oaicite:10]{index=10}ã€‚
  </div>
</header>

<main>
  <section>
    <h2>0) åŸºæœ¬æƒ…å ±</h2>
    <div class="grid cols-2">
      <label>åˆ©ç”¨è€…åï¼ˆä»»æ„ï¼‰<br><input id="u-name" type="text" placeholder="ä¾‹ï¼‰å±±ç”° èŠ±å­"></label>
      <label>ä½œæˆæ—¥ï¼ˆä»»æ„ï¼‰<br><input id="u-date" type="date"></label>
    </div>
    <details class="help" style="margin-top:8px;">
      <summary>ğŸ“˜ P.E.I.P. ã®å®šç¾©ã¨åˆ¤å®šã®åŸå‰‡ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§é–‹ãï¼‰</summary>
      <div class="helpbody">
        <b>èµ¤ï¼ˆPersonalityï¼ãã‚‚ã¡ï¼‰</b>ï¼šæ„Ÿæƒ…ãƒ»å¸Œæœ›ãƒ»ä¾¡å€¤ãƒ»ç¿’æ…£ãƒ»ä½“é¨“ã€‚<code class="k">ã€œã—ãŸã„ï¼å¥½ãï¼æ¥½ã—ã¿ï¼æ—¥èª²ï¼å¤§åˆ‡ï¼â€¦</code>ã¯èµ¤ç¢ºå®šï¼ˆRED-OVERRIDEï¼‰:contentReference[oaicite:11]{index=11}ã€‚<br>
        <b>é’ï¼ˆEnvironmentï¼ã¾ã‚ã‚Šï¼‰</b>ï¼šå®¶æ—ãƒ»è·å“¡ãƒ»åˆ¶åº¦ãƒ»ç”¨å…·ãƒ»å ´æ‰€ãƒ»æ›œæ—¥ãƒ»é »åº¦ã€<u>ç’°å¢ƒã®æ€§çŠ¶</u>ï¼ˆä¾‹ï¼šé™ã‹ï¼é¨’ãŒã—ããªã„ï¼æ˜ã‚‹ã„ï¼‰:contentReference[oaicite:12]{index=12}ã€‚<br>
        <b>é»„ï¼ˆIndependenceï¼ã§ãã‚‹ã“ã¨ï¼‰</b>ï¼šADL/IADLãƒ»è¡Œç‚ºãƒ»é »åº¦ãƒ»æ‰‹é †ï¼ˆåº§ä½ãƒ»ç«‹ä½ãƒ»æ­©è¡Œãƒ»ç§»ä¹—ã¯å¿…ãšé»„ï¼ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚‚é»„ï¼‰:contentReference[oaicite:13]{index=13}ã€‚<br>
        <b>ç·‘ï¼ˆPhysicalï¼ã‹ã‚‰ã ï¼‰</b>ï¼šæ©Ÿèƒ½ãƒ»ç—‡çŠ¶ãƒ»ç–¾æ‚£ãƒ»ç¡çœ ãƒ»è¨˜æ†¶ãƒ»åˆ¤æ–­ã€<u>è¡¨æƒ…ã®è¦³å¯Ÿ</u>ï¼ˆæ„Ÿæƒ…è£ã¥ã‘ç„¡ã—ï¼‰:contentReference[oaicite:14]{index=14}ã€‚<br>
        <div class="small">åŠ¹æœï¼ˆ01â€“100ï¼‰ï¼ãƒªã‚¹ã‚¯ï¼ˆ01â€“100ï¼‰ï¼å„ªå…ˆé †ä½ï¼ˆé…ç‚¹60ç‚¹ï¼‰ã¯å¾Œå·¥ç¨‹ã§å‚ç…§ï¼šåŠ¹æœ:contentReference[oaicite:15]{index=15}ï¼ãƒªã‚¹ã‚¯:contentReference[oaicite:16]{index=16}ï¼é…ç‚¹:contentReference[oaicite:17]{index=17}</div>
      </div>
    </details>
  </section>

  <section id="input-section">
    <div class="flex">
      <h2 class="right">0ï¼‰å…¥åŠ›ãƒ•ã‚§ãƒ¼ã‚ºï¼ˆ1è¡Œ=1é …ç›®ï¼ä¸€æ–‡ä¸€è‰²ï¼ä¸­å¿ƒä¸»é¡Œï¼‰</h2>
      <button class="btn" id="btn-add" type="button">ï¼‹ è¡Œã‚’è¿½åŠ </button>
      <button class="btn" id="btn-auto-missing" type="button">æœªåˆ†é¡ã‚’è‡ªå‹•åˆ¤åˆ¥</button>
      <button class="btn" id="btn-clear" type="button">å…¨ã‚¯ãƒªã‚¢</button>
    </div>

    <div class="summary">
      <span class="pill">åˆè¨ˆ: <strong id="count-total">0</strong></span>
      <span class="pill">èµ¤: <strong id="count-red">0</strong></span>
      <span class="pill">é’: <strong id="count-blue">0</strong></span>
      <span class="pill">é»„: <strong id="count-yellow">0</strong></span>
      <span class="pill">ç·‘: <strong id="count-green">0</strong></span>
      <span class="pill">ã‚²ãƒ¼ãƒˆ: <strong id="gate-msg" class="warn">æœªé”ï¼ˆå„è‰²2ä»¶ï¼‹åˆè¨ˆ15ä»¶ï¼‰</strong></span>
      <button class="btn primary" id="btn-go-estimate" type="button" disabled>æ¨å®šREDï¼ˆPï¼‰ã‚’ç”Ÿæˆ</button>
    </div>

    <div id="rows"></div>

    <div style="margin-top:10px;">
      <div class="small muted">ã€ä»£è¡¨çš„ãªçŸ›ç›¾ã®è‡ªå‹•æ¤œå‡ºã€‘</div>
      <ul id="warnings" class="small"></ul>
    </div>

    <div class="flex" style="margin-top:10px;">
      <button class="btn" id="btn-csv" type="button">å…¥åŠ›ä¸€è¦§CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
    </div>
  </section>

  <section id="estimate-section" style="display:none;">
    <h2>0.9ï¼‰æ¨å®šREDï¼ˆæ¨å®šPï¼‰å€™è£œ</h2>
    <div class="small muted">å¼ï¼š<span style="font-family:ui-monospace">ä¿¡é ¼åº¦ = 3Ã—é»„ + 2Ã—é’ + 1Ã—ç·‘ + ä¸€è²«æ€§(0ã€œ3) âˆ’ ç«¶åˆ(0ã€œ3)</span></div>
    <div id="candidates"></div>
    <div class="flex" style="margin-top:12px;">
      <button class="btn primary" id="btn-persona" type="button" disabled>1.0ï¼‰äººç‰©åƒï¼ˆ500å­—ï¼‰ã‚’ä½œæˆ</button>
      <span class="small muted">â€»ã€Œæ¡ç”¨ã€ã‚’1ä»¶ä»¥ä¸Šé¸ã¶ã¨æœ‰åŠ¹åŒ–</span>
    </div>
  </section>

  <section id="persona-section" style="display:none;">
    <h2>1.0ï¼‰äººç‰©åƒï¼ˆ500å­—ãƒ»ç´ æ¡ˆï¼‰</h2>
    <textarea id="persona-text" placeholder="ã“ã“ã«äººç‰©åƒãŒç”Ÿæˆã•ã‚Œã¾ã™"></textarea>
    <div class="flex" style="margin-top:8px;">
      <button class="btn" id="btn-copy" type="button">äººç‰©åƒã‚’ã‚³ãƒ”ãƒ¼</button>
    </div>
  </section>
</main>

<div class="foot small muted">
  ã‚»ãƒ«ãƒ•ãƒã‚§ãƒƒã‚¯ï¼šä¸€æ–‡ä¸€è‰²ï¼ä¸»é¡Œã§æ±ºå®šã€‚è¡Œç‚º=é»„ãƒ»ç’°å¢ƒ=é’ãƒ»æ©Ÿèƒ½=ç·‘ã€‚è¡¨æƒ…èªã¯åˆæœŸ=ç·‘ï¼ˆæœ¬äººç™ºè¨€ã§ã®ã¿èµ¤ã¸ï¼‰ã€‚:contentReference[oaicite:18]{index=18} :contentReference[oaicite:19]{index=19}
</div>

<!-- Modal -->
<div id="modal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="box">
    <h3 id="modal-title">ç¢ºèª</h3>
    <div id="modal-body" class="small"></div>
    <div id="modal-opts" class="optlist"></div>
    <div class="flex">
      <span class="hint" id="modal-hint"></span>
      <button class="btn right" id="modal-close" type="button">é–‰ã˜ã‚‹</button>
    </div>
  </div>
</div>

<script>
/* ===========================================================
   P.E.I.P.è‡ªå‹•åˆ†é¡ã‚¨ãƒ³ã‚¸ãƒ³ï¼ˆå®šç¾©æº–æ‹ ãƒ»å®‰å®šç‰ˆï¼‰
   â”€ å„ªå…ˆé †ï¼šRED-OVERRIDE > é’ï¼ˆå‘¨å›²/ç”¨å…·/é »åº¦/ç’°å¢ƒã®æ€§çŠ¶ï¼‰> é»„ï¼ˆADL/IADL/äº¤æµãƒ»æ„Ÿè¦šè¡Œç‚ºï¼‰> ç·‘ï¼ˆæ©Ÿèƒ½ãƒ»ç–¾æ‚£ãƒ»è¡¨æƒ…ï¼‰
   â”€ é»„/ç·‘å¢ƒç•Œï¼šè¡Œç‚ºã«è½ã¨ã›ã‚Œã°é»„ï¼ˆæ©Ÿèƒ½ã¯å‰¯æ¬¡ã‚¿ã‚°ï¼‰ï¼è¡¨æƒ…èªã¯åˆæœŸ=ç·‘ï¼ˆæœ¬äººç™ºè¨€ã§èµ¤ã¸ï¼‰
   â”€ æœªä¸€è‡´ã¯ã€Œæœªåˆ†é¡ã€ã®ã¾ã¾ï¼ˆè‡ªå‹•ã§ç·‘ã«ã—ãªã„ï¼‰
   â”€ å‚ç…§ï¼šP.E.I.P.å®šç¾©ãƒ»åˆ†é¡è¦ç¨‹ãƒ»ä»‹è­·ç¦ç¥‰ã®ç†å¿µï¼ˆè³‡æ–™ï¼‰:contentReference[oaicite:20]{index=20} :contentReference[oaicite:21]{index=21}
=========================================================== */

(function(){

  /* ---------- DOM å–å¾—ï¼ˆãƒœã‚¿ãƒ³å‹•ä½œã®å®‰å®šåŒ–ï¼šaddEventListenerã§æŸã­ã‚‹ï¼‰ ---------- */
  const rowsEl = document.getElementById('rows');

  const countTotalEl = document.getElementById('count-total');
  const countRedEl   = document.getElementById('count-red');
  const countBlueEl  = document.getElementById('count-blue');
  const countYellowEl= document.getElementById('count-yellow');
  const countGreenEl = document.getElementById('count-green');
  const gateMsgEl    = document.getElementById('gate-msg');
  const warningsEl   = document.getElementById('warnings');

  const btnAdd          = document.getElementById('btn-add');
  const btnAutoMissing  = document.getElementById('btn-auto-missing');
  const btnClear        = document.getElementById('btn-clear');
  const btnGoEstimate   = document.getElementById('btn-go-estimate');
  const btnCsv          = document.getElementById('btn-csv');
  const btnPersona      = document.getElementById('btn-persona');
  const btnCopy         = document.getElementById('btn-copy');

  const estimateWrap = document.getElementById('estimate-section');
  const personaWrap  = document.getElementById('persona-section');
  const personaEl    = document.getElementById('persona-text');

  const modal      = document.getElementById('modal');
  const modalTitle = document.getElementById('modal-title');
  const modalBody  = document.getElementById('modal-body');
  const modalOpts  = document.getElementById('modal-opts');
  const modalHint  = document.getElementById('modal-hint');
  const modalClose = document.getElementById('modal-close');

  /* ---------- åˆ†é¡è¾æ›¸ ---------- */
  const dict = {
    // è¡¨æƒ…èªï¼ˆåˆæœŸ=ç·‘ï¼‰
    expr: /(ç¬‘é¡”|ç¬‘ã¿|æ¶™|æ³£ã„|ã—ã‹ã‚é¢|è¡¨æƒ…(ãŒ|ãŒä¹ã—ã„|ç¡¬ã„)?|é¡”è‰²)/,

    // RED-OVERRIDEï¼ˆå¸Œæœ›ãƒ»æ„Ÿæƒ…ãƒ»ä¾¡å€¤ãƒ»ç¿’æ…£ï¼‰
    red: /(ã—ãŸã„|ã§ã‚ã‚ŠãŸã„|ç¶šã‘ãŸã„|å®ˆã‚ŠãŸã„|è¡ŒããŸã„|ä¼šã„ãŸã„|é£Ÿã¹ãŸã„|é£²ã¿ãŸã„|æ¥½ã—ã¿|å¥½ã|å¤§åˆ‡ã«ã—ã¦ã„ã‚‹|ã“ã ã‚ã‚Š|èª‡ã‚Š|å¿ƒç´°ã„|å¯‚ã—ã„|å®‰å¿ƒ|å¹¸ã›|æœ›ã¿|é¡˜ã„|æ—¥èª²|ã—ã¦ã»ã—ã„)/,

    // é’ï¼šä¸»èªãŒå‘¨å›²ï¼ç”¨å…·ï¼ã‚µãƒ¼ãƒ“ã‚¹ï¼é »åº¦ï¼ç’°å¢ƒã®æ€§çŠ¶
    actorStart: /^(å®¶æ—|å¤«|å¦»|å¨˜|æ¯å­|å­«|å‹äºº|è¿‘æ‰€|ãƒ˜ãƒ«ãƒ‘|ä»‹è­·|çœ‹è­·|ãƒªãƒ|ã‚±ã‚¢ãƒãƒ|ã‚¹ã‚¿ãƒƒãƒ•|æ–½è¨­|ãƒ‡ã‚¤|é€šæ‰€|è¨ªå•|ã‚·ãƒ§ãƒ¼ãƒˆ)/,
    actors: /(å®¶æ—|å¤«|å¦»|å¨˜|æ¯å­|å­«|å‹äºº|è¿‘æ‰€|ãƒ˜ãƒ«ãƒ‘|ä»‹è­·|çœ‹è­·|ãƒªãƒ|ã‚±ã‚¢ãƒãƒ|ã‚¹ã‚¿ãƒƒãƒ•|æ–½è¨­|ãƒ‡ã‚¤|é€šæ‰€|è¨ªå•|ã‚·ãƒ§ãƒ¼ãƒˆ|å±…å®…|ã‚µè²¬|ã‚­ãƒ¼ãƒ‘ãƒ¼ã‚½ãƒ³)/,
    supportV: /(æ‰‹ä¼|ä»‹åŠ©|æ”¯æ´|å£°ã‹ã‘|è¦‹å®ˆ|æ³¨æ„|ä¿ƒ|åŒè¡Œ|é€è¿|ä»˜ãæ·»|åŠ©ã‘)/,
    service: /(ãƒ‡ã‚¤|é€šæ‰€|è¨ªå•|ã‚·ãƒ§ãƒ¼ãƒˆ|ã‚µãƒ¼ãƒ“ã‚¹|æ–½è¨­|å…¥æ‰€)/,
    schedule: /(æ¯æ—¥|æ¯æœ|æ¯æ™©|é€±\s*\d+å›|é€±[ä¸€äºŒä¸‰å››äº”]?å›|æœˆ\s*\d+å›|æ›œæ—¥|åˆå‰|åˆå¾Œ|\d{1,2}\s*æ™‚)/,
    device: /(æ–|æ­©è¡Œå™¨|æ‰‹ã™ã‚Š|ã‚¹ãƒ­ãƒ¼ãƒ—|è»Šæ¤…å­|ã‚·ãƒ«ãƒãƒ¼ã‚«ãƒ¼|çœ¼é¡|è€çœ¼é¡|è£œè´å™¨|ç´™ãƒ‘ãƒ³ãƒ„|ã‚ªãƒ ãƒ„|ç¾©æ­¯|ãƒãƒ¼ã‚¿ãƒ–ãƒ«ãƒˆã‚¤ãƒ¬|åœ¨å®…é…¸ç´ |ãƒŠãƒ¼ã‚¹ã‚³ãƒ¼ãƒ«|ã‚»ãƒ³ã‚µãƒ¼|ãƒ™ãƒƒãƒ‰)/,

    // ç’°å¢ƒã®æ€§çŠ¶ãƒ»é¸å¥½
    envNouns: /(å‘¨å›²|ç’°å¢ƒ|éƒ¨å±‹|å±…å®¤|å ´æ‰€|ç©ºé–“|ãƒ›ãƒ¼ãƒ«|ãƒ‡ã‚¤ãƒ«ãƒ¼ãƒ |åº­|å…¬åœ’|å±‹å¤–|å±‹å†…|å»Šä¸‹|å»ºç‰©|éŸ³|é¨’éŸ³|é›‘éŸ³|å…‰|ç…§æ˜|æ—¥å·®ã—|æ—¥å½“ãŸã‚Š|åŒ‚ã„|è‡­ã„|é¦™ã‚Š|æ¸©åº¦|æ¹¿åº¦|æ›æ°—|é¢¨é€šã—|æ˜ã‚‹ã•|æš—ã•|è‰²)/,
    envQual : /(é™ã‹|é™ç©|é™ã¾ã‚Š|é¨’ãŒã—ã„|é¨’ãŒã—ããªã„|ã†ã‚‹ã•ã„|ã«ãã‚„ã‹|éŸ³ãŒ(å°ã•ã„|å¤§ãã„)|é›‘éŸ³|æ˜ã‚‹ã„|æš—ã„|çœ©ã—ã„|æ›æ°—|ä¹¾ç‡¥|æ¹¿åº¦|å¯’ã„|æš‘ã„|æ¶¼ã—ã„|æš–ã‹ã„|åŒ‚ã„|è‡­ã„|é¦™ã‚Š)/,
    preferEnv: /(å¥½ã‚€|å¥½ã¿|å¥½ããª|è½ã¡ç€ã|åˆã£ã¦ã„ã‚‹|é¦´æŸ“ã‚€)/,

    // é»„ï¼šADL/IADL/äº¤æµãƒ»æ„Ÿè¦šè¡Œç‚º
    adl: /(åº§ä½|ç«¯åº§ä½|ç«‹ä½|èµ·ç«‹|èµ·ãä¸ŠãŒ|å¯è¿”ã‚Š|æ­©(è¡Œ|ã‘)|æ•£æ­©|å¤–å‡º|ç§»ä¹—|ãƒˆã‚¤ãƒ¬|æ’æ³„|æ¸…æ‹­|é£Ÿäº‹|æ›´è¡£|å…¥æµ´|æ´—é¢|æ•´å®¹|æ­¯ç£¨ã|å£è…”)/,
    iadl: /(èª¿ç†|æ–™ç†|è²·ã„ç‰©|æ´—æ¿¯|æƒé™¤|ç‰‡ä»˜ã‘|ã‚´ãƒŸå‡ºã—|ã”ã¿å‡ºã—|æœè–¬|è–¬|é‡‘éŠ­|è²¡å¸ƒ|éŠ€è¡Œ|å…¬å…±æ–™é‡‘|é€šé™¢|æ‰‹ç¶š|äºˆç´„|äºˆå®š|ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«|é›»è©±|é€£çµ¡|ã‚¹ãƒãƒ›|LINE|ãƒ¡ãƒ¼ãƒ«|æƒ…å ±æ©Ÿå™¨|æ›¸ã|èª­ã‚€|èª­æ›¸|æ–°è|éµ|æ–½éŒ |è§£éŒ |ä¼šè©±|ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³|ä¼ãˆã‚‹|ç­†è«‡)/,
    comm: /(ä¼šè©±|è©±|èãå–|é€šè©±|ä¼ãˆã‚‹|æ„æ€ç–é€š|è¿”ç­”|äº¤æµ|é–¢ã‚ã‚Š|ãµã‚Œã‚ã„|è§¦ã‚Œåˆã„|ã‚„ã‚Šã¨ã‚Š|ã‚„ã‚Šå–ã‚Š|ã¤ãªãŒã‚Š)/,
    ability: /(ã§ããªã„|é›£ã—ã„|ç„¡ç†|ä¸å¯èƒ½|ã‚ã‹ã‚‰ãªã„|åˆ†ã‹ã‚‰ãªã„|è¦šãˆã‚‰ã‚Œãªã„|å¿˜ã‚Œ(ã‚‹|ãŒã¡)?|ä¸­æ–­|èª¤ã‚Š|é–“é•ãˆ|æ”¾ç½®|æ‰‹é †|æ®µå–ã‚Š|è¿·ã†|æ··ä¹±)/,

    // ç·‘ï¼šæ©Ÿèƒ½/ç–¾æ‚£/ç—‡çŠ¶
    dx: /(è¨ºæ–­|ç—…å|ç—‡å€™ç¾¤|éª¨æŠ˜|éº»ç—º|å¤±èª|ãƒ‘ãƒ¼ã‚­ãƒ³ã‚½ãƒ³|èªçŸ¥ç—‡|è„³æ¢—å¡|ãƒ•ãƒ¬ã‚¤ãƒ«|é«˜è¡€åœ§|ç³–å°¿ç—…|å¿ƒä¸å…¨|è…ä¸å…¨|ãŒã‚“|ç™Œ|é›£ç—…|é¬±|æŠ‘ã†ã¤)/,
    func: /(ç—›|ç–¼ç—›|ã‚€ã›|åš¥ä¸‹|èª¤åš¥|ç—°|æ¯è‹¦|å‘¼å¸|ä¸çœ |ç¡çœ |å¤œé–“è¦šé†’|ç–²ã‚Œ|æ˜“ç–²åŠ´|ã ã‚‹|ã‚ã¾ã„|ãµã‚‰ã¤ã|ä¾¿ç§˜|ä¸‹ç—¢|å¤±ç¦|è¡€åœ§|é£Ÿæ¬²|è„±æ°´|æµ®è…«|ã—ã³ã‚Œ)/,
    cog: /(è¨˜æ†¶|å¿˜|è¦šãˆ|åˆ¤æ–­|ç†è§£|æ³¨æ„|é›†ä¸­|è¦‹å½“è­˜|è¦–åŠ›|è¦–é‡|è¦‹ãˆ|èã“ãˆ|å¹»è¦–|å¹»è´|å¦„æƒ³|çŸ¥èƒ½|è¨ˆç®—)/,

    // è¡Œç‚ºï¼ˆæ‰‹ãƒ»ç›®ï¼‰
    handEyeVerb: /(å‘ã‘ã‚‹|è¦‹ã¤ã‚|æ³¨è¦–|è¦‹ã‚‹|è¦‹ã¦|é®ã‚‹|é ã–ã‘ã‚‹|æ‰•ã†|ã²ã‚‰ã²ã‚‰|æŒ¯ã‚‹|ä¼¸ã°ã™|è§¦ã‚Œã‚‹|æ´ã‚€|æŒã¤|æ”¾ã™|æ“ä½œ|é‹å‹•|æ´»å‹•|éŠã³)/
  };

  function escapeHtml(s){ return s.replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  // å‰¯æ¬¡ã‚¿ã‚°ï¼ˆUIé›†è¨ˆå¤–ï¼‰
  function subTags(text){
    const tags = [];
    if (dict.device.test(text)) tags.push('BLUE_DEVICE');
    if (dict.schedule.test(text) && /(ãƒ‡ã‚¤|é€šæ‰€|è¨ªå•|ã‚µãƒ¼ãƒ“ã‚¹)/.test(text)) tags.push('BLUE_SCHEDULE');
    if (dict.actors.test(text) && dict.supportV.test(text)) tags.push('BLUE_SUPPORT');

    if (/(åº§ä½|ç«¯åº§ä½|ç«‹ä½|èµ·ç«‹|èµ·ãä¸ŠãŒ|å¯è¿”ã‚Š|æ­©)/.test(text)) tags.push('YELLOW_ADL');
    if (dict.iadl.test(text) || dict.comm.test(text)) tags.push('YELLOW_IADL');
    if (/(é–¢ã‚ã‚Š|äº¤æµ|ãµã‚Œã‚ã„|è§¦ã‚Œåˆã„|ã‚„ã‚Šã¨ã‚Š|ã‚„ã‚Šå–ã‚Š|ã¤ãªãŒã‚Š)/.test(text)) tags.push('YELLOW_COMMUNICATION');

    if (/è¨˜æ†¶|å¿˜/.test(text)) tags.push('GREEN_FUNCTION_MEMORY');
    if (/åˆ¤æ–­|ç†è§£|ã‚ã‹ã‚‰|åˆ†ã‹ã‚‰/.test(text)) tags.push('GREEN_FUNCTION_DECISION');
    if (/æ‰‹é †|æ®µå–ã‚Š|ä¸­æ–­|æ”¾ç½®/.test(text)) tags.push('GREEN_FUNCTION_EXECUTIVE');
    if (/æ³¨æ„|é›†ä¸­/.test(text)) tags.push('GREEN_FUNCTION_ATTENTION');
    if (/è¦–åŠ›|è¦–é‡|è¦‹ãˆ/.test(text)) tags.push('GREEN_FUNCTION_VISION');
    if (/èã“ãˆ/.test(text)) tags.push('GREEN_FUNCTION_HEARING');
    if (/å§¿å‹¢|ä½“å¹¹|ãƒãƒ©ãƒ³ã‚¹/.test(text)) tags.push('GREEN_FUNCTION_POSTURE');
    return tags;
  }

  // æ˜ç¤ºãƒãƒƒãƒï¼šç’°å¢ƒã®æ€§çŠ¶/é¸å¥½ â†’ é’
  function matchBlueEnvironment(t){
    if (dict.envNouns.test(t) && dict.envQual.test(t) && !/(ã™ã‚‹|ã—ã¦ã„ã‚‹|ã§ãã‚‹|å‘ã‘ã‚‹|è¦‹ã‚‹|è¦‹ã¦|æ³¨è¦–|æ´»å‹•|éŠã³|é–¢å¿ƒ)/.test(t)) {
      return {color:'é’', reason:'ç’°å¢ƒã®æ€§çŠ¶ï¼ˆéŸ³ãƒ»å…‰ãƒ»æ¸©åº¦ ç­‰ï¼‰ã®è¨˜è¿°', tags: subTags(t)};
    }
    if (dict.preferEnv.test(t) && /(ç’°å¢ƒ|å ´æ‰€|éŸ³|å…‰|è‰²|åŒ‚ã„|é¦™ã‚Š|æ˜ã‚‹ã•|æš—ã•|æ¸©åº¦|é™ã‹|é¨’ãŒã—ããªã„)/.test(t)) {
      return {color:'é’', reason:'ç’°å¢ƒé¸å¥½ï¼ˆãã®å ´/ã‚„ã‚Šæ–¹ãŒåˆã£ã¦ã„ã‚‹ï¼‰', tags: subTags(t)};
    }
    return null;
  }

  // æ˜ç¤ºãƒãƒƒãƒï¼šäº¤æµãƒ»æ‰‹/ç›®ã®è¡Œç‚º â†’ é»„
  function matchYellowAction(t){
    if (dict.comm.test(t) && /(ã‚ã‚‹|ãªã„|ã—ã¦ã„ã‚‹|ã™ã‚‹|ã§ãã‚‹)/.test(t)) {
      return {color:'é»„', reason:'äº¤æµ/é–¢ã‚ã‚Šï¼ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³é‚è¡Œï¼ˆIADLï¼‰', tags:['YELLOW_COMMUNICATION'].concat(subTags(t))};
    }
    if ((/(æ‰‹|ç›®|æŒ‡|è…•|èº«ä½“|ä½“|è¦–ç·š)/.test(t) && dict.handEyeVerb.test(t)) || /(é‹å‹•|æ´»å‹•|éŠã³).*(ã—ã¦ã„ã‚‹|ã™ã‚‹|ã§ãã‚‹)/.test(t)) {
      return {color:'é»„', reason:'æ‰‹ãƒ»ç›®ãƒ»æ„Ÿè¦šã«ã‚ˆã‚‹è¡Œç‚ºã®é‚è¡Œï¼ˆADL/IADLï¼‰', tags: subTags(t).concat('YELLOW_ADL')};
    }
    if (/(ã—ã¦ã„ã‚‹|ã™ã‚‹|ã§ãã‚‹)/.test(t) && /(æ‰‹|ç›®|æŒ‡|è…•|èº«ä½“|ä½“|è¦–ç·š)/.test(t)) {
      return {color:'é»„', reason:'èº«ä½“éƒ¨ä½ã‚’ä¼´ã†è¡Œç‚ºã®é‚è¡Œï¼ˆADLï¼‰', tags: subTags(t).concat('YELLOW_ADL')};
    }
    return null;
  }

  function subjectLabel(color){
    return color==='èµ¤' ? 'å€‹äººçš„ï¼ˆãã‚‚ã¡ï¼šå¸Œæœ›ãƒ»æ„Ÿæƒ…ãƒ»ä¾¡å€¤ãƒ»ç¿’æ…£ï¼‰'
         : color==='é’' ? 'ç’°å¢ƒï¼ˆå®¶æ—ãƒ»è·å“¡ãƒ»åˆ¶åº¦ãƒ»ç”¨å…·ãƒ»æ‰€æœ‰/è¨­ç½®ãƒ»é »åº¦ãƒ»æ€§çŠ¶ï¼‰'
         : color==='é»„' ? 'è‡ªç«‹ï¼ˆADL/IADL/äº¤æµãƒ»æ„Ÿè¦šè¡Œç‚ºï¼‰'
         : color==='ç·‘' ? 'èº«ä½“ï¼ˆæ©Ÿèƒ½ãƒ»ç–¾æ‚£ãƒ»ç—‡çŠ¶ãƒ»è¡¨æƒ…ï¼‰'
         : 'æœªåˆ†é¡';
  }

  // åˆ†é¡ï¼ˆP.E.I.P.ï¼‰
  function classifyPEIP(text, opts={popup:true, row:null}){
    const t = (text||'').trim();
    if(!t) return {color:'', reason:'', tags:[]};

    // è¡¨æƒ…èªï¼šåˆæœŸ=ç·‘ï¼ˆè£ã¥ã‘ã‚ã‚Œã°èµ¤ã¸ï¼‰
    if (dict.expr.test(t) && !/æ¥½ã—ã„|å¬‰ã—ã„|æ‚²ã—ã„|æ€–ã„|ä¸å®‰|å®‰å¿ƒ|å¥½ã|å«Œ/.test(t)) {
      if(opts.popup) scheduleEmotionPopup(opts.row);
      return {color:'ç·‘', reason:'è¡¨æƒ…ã®è¦³å¯Ÿï¼ˆåˆæœŸ=ç·‘ï¼‰ã€‚æœ¬äººç™ºè¨€ã§æ„Ÿæƒ…ãŒè£ã¥ã‘ã°èµ¤ã¸', tags: subTags(t)};
    }

    // â‘ ç’°å¢ƒã®æ€§çŠ¶/é¸å¥½ï¼ˆé’ï¼‰
    const envHit = matchBlueEnvironment(t);
    if (envHit) return envHit;

    // â‘¡äº¤æµãƒ»æ‰‹/ç›®ã®è¡Œç‚ºï¼ˆé»„ï¼‰
    const actHit = matchYellowAction(t);
    if (actHit) return actHit;

    // â‘¢RED-OVERRIDEï¼ˆå¸Œæœ›ãƒ»æ„Ÿæƒ…ãƒ»ç¿’æ…£ãƒ»ä¾¡å€¤ï¼‰
    if (dict.red.test(t)) {
      return {color:'èµ¤', reason:'å¸Œæœ›ãƒ»æ„Ÿæƒ…ãƒ»ä¾¡å€¤ãƒ»ç¿’æ…£ã®æ˜ç¤ºï¼ˆRED-OVERRIDEï¼‰', tags:['RED_OVERRIDE'].concat(subTags(t))};
    }

    // â‘£ã‚¹ã‚³ã‚¢ï¼ˆé’/é»„/ç·‘ï¼‰
    let sb=0, sy=0, sg=0; const reasons=[];

    if (dict.actorStart.test(t)) { sb+=5; reasons.push('ä¸»èª=å®¶æ—/è·å“¡/ã‚µãƒ¼ãƒ“ã‚¹'); }
    if (dict.actors.test(t) && dict.supportV.test(t)) { sb+=3; reasons.push('å®¶æ—/è·å“¡ã®æ”¯æ´å‹•è©'); }
    if (dict.service.test(t) && dict.schedule.test(t)) { sb+=3; reasons.push('ã‚µãƒ¼ãƒ“ã‚¹ã®é »åº¦/å›æ•°'); }
    if (dict.device.test(t) && !/(è£…ç€|äº¤æ›|ä»˜ã‘|å¤–ã™|ä½¿ã†)/.test(t)) { sb+=3; reasons.push('ç”¨å…·ã®æ‰€æœ‰/è¨­ç½®'); }

    if (/(åº§ä½|ç«‹ä½|æ­©è¡Œ|æ­©ã‘|ç§»ä¹—)/.test(t)) { sy+=6; reasons.push('åº§ä½/ç«‹ä½/æ­©è¡Œ/ç§»ä¹—ï¼å¿…ãšé»„ï¼ˆADLï¼‰'); }
    if (dict.adl.test(t)) { sy+=4; reasons.push('ADLã®é‚è¡Œ'); }
    if (dict.iadl.test(t)) { sy+=4; reasons.push('IADLã®é‚è¡Œï¼ˆå·¥ç¨‹ãƒ»è‡ªå·±ç®¡ç†ãƒ»é€£çµ¡ï¼‰'); }
    if (dict.comm.test(t)) { sy+=2; reasons.push('ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯IADLã¨ã—ã¦é»„'); }
    if (dict.schedule.test(t) && !dict.service.test(t)) { sy+=1; reasons.push('æœ¬äººã®äºˆå®šãƒ»æ®µå–ã‚Š'); }
    if (dict.ability.test(t) && (dict.adl.test(t)||dict.iadl.test(t)||dict.comm.test(t))) { sy+=1; reasons.push('è¡Œç‚ºã¸ã®é›£æ˜“è¡¨ç¾'); }

    if (dict.dx.test(t))  { sg+=4; reasons.push('è¨ºæ–­/ç—…å'); }
    if (dict.func.test(t)){ sg+=3; reasons.push('èº«ä½“ç—‡çŠ¶ï¼ˆç—›ã¿ãƒ»åš¥ä¸‹ãƒ»ç¡çœ  ç­‰ï¼‰'); }
    if (dict.cog.test(t)) { sg+=3; reasons.push('èªçŸ¥ãƒ»æ„Ÿè¦šã®æ©Ÿèƒ½'); }
    if (dict.ability.test(t) && !(dict.adl.test(t)||dict.iadl.test(t)||dict.comm.test(t))) { sg+=1; reasons.push('è¡Œç‚ºã«è½ã¡ãªã„æ©Ÿèƒ½èª'); }

    // ä»£è¡¨ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆIADLç³»ï¼‰
    if (/(ã‚¹ãƒãƒ›|ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³|æºå¸¯|ãƒ‘ã‚½ã‚³ãƒ³|PC|ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ|æ–°è|æœ¬|æ–‡å­—)/.test(t) && /(è¦‹ãˆã«ãã„|è¦‹ã«ãã„|å°ã•ãã¦è¦‹ãˆ|èª­ã‚ãªã„|èª­ã¿ã¥ã‚‰ã„)/.test(t)) {
      return {color:'é»„', reason:'æƒ…å ±æ©Ÿå™¨ãƒ»èª­ã‚€ï¼IADLï¼ˆè¦–è¦šã¯å‰¯æ¬¡ï¼‰', tags: subTags(t).concat('GREEN_FUNCTION_VISION','YELLOW_IADL')};
    }
    if (/çœ¼é¡|è€çœ¼é¡|ç¾©æ­¯/.test(t) && /(è¦‹ãˆã«ãã„|è¦‹ã«ãã„|èª­ã‚ãªã„|å™›ã‚ãªã„|åš™ã‚ãªã„)/.test(t) && !/(ã‚¹ãƒãƒ›|ãƒ‘ã‚½ã‚³ãƒ³|æ–°è|æœ¬)/.test(t)) {
      return {color:'ç·‘', reason:'æ„Ÿè¦šæ©Ÿèƒ½ï¼ˆç”¨å…·ã¯BLUE_DEVICEï¼‰', tags: subTags(t).concat('BLUE_DEVICE')};
    }
    if (/(é›»è©±).*(å—ã‘|å‡ºã‚‰ã‚Œ|å¿œç­”).*(ãŒ|ã‘ã©|ã—ã‹ã—).*(ã‹ã‘|ç™ºä¿¡).*(ã§ããªã„|é›£ã—ã„)/.test(t)) {
      return {color:'é»„', reason:'é›»è©±ã®é‚è¡Œï¼ˆIADLï¼‰ï¼šå—ä¿¡å¯ãƒ»ç™ºä¿¡ä¸å¯', tags: subTags(t).concat('YELLOW_IADL','YELLOW_COMMUNICATION')};
    }
    if (/å¸¸æ™‚/.test(t) && /(ç´™ãƒ‘ãƒ³ãƒ„|ã‚ªãƒ ãƒ„|æ–|çœ¼é¡|è£œè´å™¨|è»Šæ¤…å­|ç¾©æ­¯)/.test(t) && !/(äº¤æ›|è£…ç€|å¤–ã™|ä½¿ã†)/.test(t)) {
      return {color:'é’', reason:'ç”¨å…·ã®æ’å¸¸çš„ä½¿ç”¨ï¼ˆBLUE_DEVICEï¼‰', tags: subTags(t)};
    }

    // æœ€çµ‚æ±ºå®š
    let color='';
    const maxScore = Math.max(sb, sy, sg, 0);
    if (maxScore===0) return {color:'', reason:'åˆ¤å®šææ–™ãŒä¸è¶³ï¼ˆæœªåˆ†é¡ï¼‰', tags:[]};
    if (sy>0 && sy>=maxScore) color='é»„';
    else if (sb>0 && sb>=Math.max(sy,sg)) color='é’';
    else if (sg>0) color='ç·‘';

    // æ©Ÿèƒ½èªã®ã¿â†’è¡Œç‚ºã«è½ã¨ã›ã‚‹ã‹å†ç¢ºèª
    if (color==='ç·‘' && /(ã§ããªã„|é›£ã—ã„|ã‚ã‹ã‚‰ãªã„|è¦šãˆã‚‰ã‚Œãªã„|å¿˜ã‚Œ|åˆ¤æ–­)/.test(t) &&
       !/(ä¼šè©±|è©±|é€£çµ¡|èª­ã‚€|æ›¸ã|é›»è©±|æ­©|ç§»ä¹—|ç«‹ä½|åº§ä½|ãƒˆã‚¤ãƒ¬|èª¿ç†|æ´—æ¿¯|æƒé™¤|ç‰‡ä»˜ã‘|äºˆå®š|ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«|é‡‘éŠ­)/.test(t)) {
      scheduleFunctionPopup(opts?.row);
    }

    const reason = reasons.join('ï¼') || subjectLabel(color);
    return {color, reason, tags: subTags(t)};
  }

  /* ---------- çŸ›ç›¾æ¤œå‡º ---------- */
  const contradictions = [
    {a:/åŒå±…/, b:/ä¸€äººæš®ã‚‰ã—|ç‹¬å±…/, label:'ã€ŒåŒå±…ã€ã¨ã€Œç‹¬å±…ã€ãŒæ··åœ¨'},
    {a:/å¤–å‡º(ã§ãã‚‹|ã—ã¦ã„ã‚‹)/, b:/å¤–å‡º(ã§ããªã„|ã—ãªã„)/, label:'ã€Œå¤–å‡ºã§ãã‚‹ã€ã¨ã€Œå¤–å‡ºã§ããªã„ã€ãŒæ··åœ¨'},
    {a:/å¤œé–“.*ãƒˆã‚¤ãƒ¬.*(è‡ªç«‹|ä¸€äºº|è¡Œã‘ã‚‹)/, b:/å¸¸æ™‚.*(ã‚ªãƒ ãƒ„|ç´™ãƒ‘ãƒ³ãƒ„)/, label:'ã€Œå¤œé–“ãƒˆã‚¤ãƒ¬è‡ªç«‹ã€ã¨ã€Œå¸¸æ™‚ã‚ªãƒ ãƒ„ã€ãŒæ··åœ¨'},
  ];

  /* ---------- è¡ŒUI ---------- */
  function addRow(text=''){
    const i = rowsEl.children.length + 1;
    const row = document.createElement('div');
    row.className = 'row';
    row.innerHTML = `
      <div class="idx">#<span class="i">${i}</span></div>
      <input type="text" class="t" placeholder="1è¡Œ=1é …ç›®ï¼ˆä¾‹ï¼šã€å‘¨å›²ã¯é¨’ãŒã—ããªã„ã€ã€äººã¨ã®é–¢ã‚ã‚Šã¯ã‚ã‚‹ã€ã€å‹•ãã®ãªã„å…‰ã«ç›®ã‚’å‘ã‘ã‚‹ã€ï¼‰" value="${escapeHtml(text)}" />
      <select class="c">
        <option value="">ï¼ˆæœªåˆ†é¡ï¼‰</option>
        <option value="èµ¤">èµ¤ï¼ˆPersonalityï¼‰</option>
        <option value="é’">é’ï¼ˆEnvironmentï¼‰</option>
        <option value="é»„">é»„ï¼ˆIndependenceï¼‰</option>
        <option value="ç·‘">ç·‘ï¼ˆPhysicalï¼‰</option>
      </select>
      <span class="small muted reason"></span>
      <button type="button" class="btn auto">è‡ªå‹•åˆ¤åˆ¥</button>
      <button type="button" class="btn del">å‰Šé™¤</button>
    `;
    rowsEl.appendChild(row);

    // è¡Œã‚¤ãƒ™ãƒ³ãƒˆï¼šã“ã“ã§ addEventListenerï¼ˆonclickã«ä¾å­˜ã—ãªã„ï¼ãƒ–ãƒ©ã‚¦ã‚¶å·®å›é¿ï¼‰
    row.querySelector('.t').addEventListener('input', updateAll);
    row.querySelector('.c').addEventListener('change', updateAll);
    row.querySelector('.auto').addEventListener('click', ()=> autoDetectRow(row, true));
    row.querySelector('.del').addEventListener('click', ()=> { row.remove(); renumber(); updateAll(); });
  }
  function renumber(){ [...rowsEl.children].forEach((row,idx)=> row.querySelector('.i').textContent=String(idx+1)); }

  // 1è¡Œè‡ªå‹•åˆ¤åˆ¥
  function autoDetectRow(row, withPopup=true){
    const t   = row.querySelector('.t').value;
    const sel = row.querySelector('.c');
    const r   = row.querySelector('.reason');
    const res = classifyPEIP(t, {popup:withPopup, row});
    sel.value = res.color || '';
    const tags = (res.tags||[]).join('|');
    r.textContent = res.color ? `ï¼ˆä¸­å¿ƒä¸»é¡Œï¼š${subjectLabel(res.color)}ï¼‰ï¼ˆtags:${tags||'ãªã—'}ï¼‰` : 'ï¼ˆæœªåˆ†é¡ï¼‰';
    row.dataset.tags = tags;
    updateAll();
  }

  // æœªåˆ†é¡ã®ã¿ä¸€æ‹¬
  function autoDetectMissing(){
    [...rowsEl.children].forEach(row=>{
      const sel = row.querySelector('.c');
      if(!sel.value) autoDetectRow(row, false);
    });
    [...rowsEl.children].forEach(row=>{
      const r = row.querySelector('.reason');
      if(!r.textContent) autoDetectRow(row, false);
    });
  }

  // åé›†ãƒ»é›†è¨ˆ
  function collect(){
    const items = [];
    [...rowsEl.children].forEach(row=>{
      const idx  = Number(row.querySelector('.i').textContent);
      const text = row.querySelector('.t').value.trim();
      const color= row.querySelector('.c').value;
      const tags = (row.dataset.tags||'').split('|').filter(Boolean);
      if(text) items.push({idx,text,color,tags});
    });
    return items;
  }

  function updateCounts(items){
    const total = items.length;
    const r = items.filter(x=>x.color==='èµ¤').length;
    const b = items.filter(x=>x.color==='é’').length;
    const y = items.filter(x=>x.color==='é»„').length;
    const g = items.filter(x=>x.color==='ç·‘').length;
    countTotalEl.textContent = total;
    countRedEl.textContent   = r;
    countBlueEl.textContent  = b;
    countYellowEl.textContent= y;
    countGreenEl.textContent = g;

    // ã‚²ãƒ¼ãƒˆï¼šèµ¤ãƒ»é’ãƒ»é»„ãƒ»ç·‘ å„2ä»¶ä»¥ä¸Šï¼‹åˆè¨ˆ15ä»¶ä»¥ä¸Š
    const need = [];
    if(total<15) need.push(`åˆè¨ˆã‚ã¨${15-total}`);
    if(r<2) need.push(`èµ¤ã‚ã¨${2-r}`);
    if(b<2) need.push(`é’ã‚ã¨${2-b}`);
    if(y<2) need.push(`é»„ã‚ã¨${2-y}`);
    if(g<2) need.push(`ç·‘ã‚ã¨${2-g}`);

    if(need.length===0){ gateMsgEl.textContent='é€šé'; gateMsgEl.className='ok'; btnGoEstimate.disabled=false; }
    else { gateMsgEl.textContent=need.join('ï¼'); gateMsgEl.className='warn'; btnGoEstimate.disabled=true; }
  }

  function updateWarnings(items){
    warningsEl.innerHTML='';
    const texts = items.map(x=>x.text);
    contradictions.forEach(pair=>{
      const hitA = texts.some(t=>pair.a.test(t));
      const hitB = texts.some(t=>pair.b.test(t));
      if(hitA && hitB) addWarn(pair.label);
    });
    const careLv = new Set();
    texts.forEach(t=>{
      const m = t.match(/è¦ä»‹è­·\s*([1-5])/);
      if(m) careLv.add(m[1]);
    });
    if(careLv.size>1) addWarn(`è¦ä»‹è­·åº¦ã®é£Ÿã„é•ã„ï¼ˆ${[...careLv].join('ï¼')}ï¼‰`);
    const hasRestrict = texts.some(t=>/æ¸›å¡©|å¡©åˆ†åˆ¶é™|ç¦é…’|ç³–è³ªåˆ¶é™|æ°´åˆ†åˆ¶é™/.test(t));
    const hasPreference = texts.some(t=>/å¡©è¾›ã„|ãŠé…’å¥½ã|ç”˜ã„ç‰©|ç”˜å…š|è„‚ã£ã“ã„/.test(t));
    if(hasRestrict && hasPreference) addWarn('é£Ÿäº‹åˆ¶é™ã¨å—œå¥½ãŒçŸ›ç›¾ã™ã‚‹å¯èƒ½æ€§');

    function addWarn(msg){
      const li = document.createElement('li');
      li.textContent = 'âš  ' + msg;
      li.className='warn small';
      warningsEl.appendChild(li);
    }
  }

  function updateAll(){
    const items = collect();
    updateCounts(items);
    updateWarnings(items);
  }

  /* ---------- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆæ©Ÿèƒ½èª/è¡¨æƒ…ï¼‰ ---------- */
  function openModal(){ modal.style.display='flex'; modal.setAttribute('aria-hidden','false'); }
  function closeModal(){ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); }
  modalClose.addEventListener('click', closeModal);

  function scheduleFunctionPopup(row){
    if(!row) return;
    openModal();
    modalTitle.textContent = 'æ©Ÿèƒ½èªã‚’æ¤œå‡ºï¼šã©ã®ç”Ÿæ´»è¡Œç‚ºã«ã‹ã‹ã‚Šã¾ã™ã‹ï¼Ÿ';
    modalBody.innerHTML = 'ã€Œã§ããªã„ï¼é›£ã—ã„ï¼ã‚ã‹ã‚‰ãªã„ï¼å¿˜ã‚Œã‚‹ï¼åˆ¤æ–­ã€ç­‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚è©²å½“ã™ã‚‹è¡Œç‚ºãŒã‚ã‚Œã°é¸æŠï¼ˆ<b>è¡Œç‚º=é»„</b>ï¼‰ã€‚è©²å½“ãªã—ã¯<b>æŠ½è±¡æ©Ÿèƒ½=ç·‘</b>ã€‚';
    modalHint.textContent = 'è¡Œç‚º=é»„ã€æ©Ÿèƒ½ã®ã¿=ç·‘ï¼ˆå‰¯æ¬¡ã‚¿ã‚°ã§æ©Ÿèƒ½ã¯ä¿æŒï¼‰';
    modalOpts.innerHTML='';
    [['åº§ä½','YELLOW_ADL'],['ç«‹ä½','YELLOW_ADL'],['æ­©è¡Œ','YELLOW_ADL'],['ç§»ä¹—','YELLOW_ADL'],
     ['ä¿å­˜ï¼ˆãƒ©ãƒƒãƒ—/å†·è”µï¼‰','YELLOW_IADL'],['å®¶é›»ï¼ˆãƒ¬ãƒ³ã‚¸/æ´—æ¿¯æ©Ÿï¼‰','YELLOW_IADL'],
     ['ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†','YELLOW_IADL'],['æœè–¬ç®¡ç†','YELLOW_IADL'],['é‡‘éŠ­ç®¡ç†','YELLOW_IADL'],
     ['é›»è©±ãƒ»é€£çµ¡ï¼ˆä¼šè©±ï¼‰','YELLOW_COMMUNICATION'],['æƒ…å ±æ©Ÿå™¨æ“ä½œãƒ»èª­ã‚€','YELLOW_IADL'],
     ['è©²å½“ãªã—ï¼ˆæŠ½è±¡æ©Ÿèƒ½ï¼ç·‘ï¼‰','NONE']
    ].forEach(([label,tag])=>{
      const b=document.createElement('button'); b.textContent=label; b.onclick=()=>{
        if(tag!=='NONE'){
          row.querySelector('.c').value='é»„';
          const t = row.querySelector('.t').value;
          const set = new Set(((row.dataset.tags||'').split('|').filter(Boolean)));
          set.add(tag);
          if(/è¨˜æ†¶|å¿˜/.test(t)) set.add('GREEN_FUNCTION_MEMORY');
          if(/åˆ¤æ–­|ç†è§£|ã‚ã‹ã‚‰|åˆ†ã‹ã‚‰/.test(t)) set.add('GREEN_FUNCTION_DECISION');
          if(/æ‰‹é †|æ®µå–ã‚Š|ä¸­æ–­|æ”¾ç½®/.test(t)) set.add('GREEN_FUNCTION_EXECUTIVE');
          row.dataset.tags=[...set].join('|');
          row.querySelector('.reason').textContent = `ï¼ˆä¸­å¿ƒä¸»é¡Œï¼š${subjectLabel('é»„')}ï¼‰ï¼ˆtags:${row.dataset.tags||'ãªã—'}ï¼‰`;
        }
        closeModal(); updateAll();
      };
      modalOpts.appendChild(b);
    });
  }

  function scheduleEmotionPopup(row){
    if(!row) return;
    openModal();
    modalTitle.textContent = 'è¡¨æƒ…èªã‚’æ¤œå‡ºï¼šè¡¨æƒ…ï¼ˆç·‘ï¼‰ã§ã™ã‹ï¼Ÿæ°—æŒã¡ï¼ˆèµ¤ï¼‰ã¾ã§ç¢ºèªã§ãã¦ã„ã¾ã™ã‹ï¼Ÿ';
    modalBody.innerHTML = 'è¡¨æƒ…èªï¼ˆä¾‹ï¼šç¬‘é¡”ãƒ»æ¶™ãƒ»è¡¨æƒ…ãŒä¹ã—ã„ï¼‰ã¯åˆæœŸã¯<b>ç·‘</b>ã€‚æœ¬äººã®ç™ºè¨€ã‚„ç¶™ç¶šæ–‡è„ˆã§æ„Ÿæƒ…ãŒè£ã¥ãå ´åˆã®ã¿<b>èµ¤</b>ã¸ã€‚';
    modalHint.textContent = 'â€»è¡¨æƒ…ã ã‘ã§ã¯èµ¤ã«ã—ã¾ã›ã‚“ã€‚';
    modalOpts.innerHTML='';
    const a=document.createElement('button'); a.textContent='Aï¼šè¡¨æƒ…ï¼ˆèº«ä½“ãƒ»ç·‘ï¼‰'; a.onclick=()=>{ row.querySelector('.c').value='ç·‘'; closeModal(); updateAll(); };
    const b=document.createElement('button'); b.textContent='Bï¼šæ°—æŒã¡ï¼ˆèµ¤ï¼šæœ¬äººç™ºè¨€ã§è£ã¥ã‘ï¼‰'; b.onclick=()=>{ row.querySelector('.c').value='èµ¤'; row.dataset.tags='RED_OVERRIDE'; closeModal(); updateAll(); };
    modalOpts.appendChild(a); modalOpts.appendChild(b);
  }

  /* ---------- æ¨å®šREDãƒ»äººç‰©åƒï¼ˆçœç•¥å¯ï¼šæ—¢å®šé€šã‚Šï¼‰ ---------- */
  const themes = [
    {id:'DailyRoutine', type:'yellow', red:'æ±ºã¾ã£ãŸæµã‚Œï¼ˆæ—¥èª²ï¼‰ã‚’ç¶šã‘ãŸã„', keys:[/æ¯æ—¥|æ¯æœ|æ¯æ™©|æ—¥èª²|ã„ã¤ã‚‚|ç¿’æ…£|ç¶™ç¶š|é€±|æ›œæ—¥|ãƒšãƒ¼ã‚¹/]},
    {id:'Mobility', type:'yellow', red:'è‡ªåˆ†ã®ãƒšãƒ¼ã‚¹ã§æ­©ããƒ»ç§»å‹•ã®è‡ªç«‹ã‚’ä¿ã¡ãŸã„', keys:[/æ­©è¡Œ|æ­©ã‘|æ•£æ­©|å¤–å‡º|ç«‹ä½|åº§ä½|ç§»ä¹—/]},
    {id:'Communication', type:'yellow', red:'è‡ªåˆ†ã®æ‰‹æ®µã§ä¼ãˆãŸã„', keys:[/ä¼šè©±|è©±|ä¼ãˆã‚‹|ç­†è«‡|ã‚¹ãƒãƒ›|LINE|é›»è©±|ãƒ¡ãƒ¼ãƒ«|èª­ã‚€|æ›¸ã|äº¤æµ|é–¢ã‚ã‚Š/]},
    {id:'Housework', type:'yellow', red:'å½¹å‰²ã®å®¶äº‹ï¼ˆèª¿ç†ãƒ»æ´—æ¿¯ãƒ»æƒé™¤ç­‰ï¼‰ã‚’ç¶šã‘ãŸã„', keys:[/èª¿ç†|æ–™ç†|è²·ã„ç‰©|æ´—æ¿¯|æƒé™¤|ç‰‡ä»˜ã‘/]},
    {id:'Medication', type:'yellow', red:'è‡ªåˆ†ã§æœè–¬ç®¡ç†ã‚’ã—ãŸã„', keys:[/æœè–¬|è–¬|é£²ã¿å¿˜ã‚Œ|æœè–¬ç®¡ç†/]},
    {id:'Schedule', type:'yellow', red:'è¦‹é€šã—ã‚’æŒã£ã¦ç”Ÿæ´»ã—ãŸã„', keys:[/ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«|äºˆå®š|æ™‚é–“|æ›œæ—¥|äºˆç´„/]},
    {id:'Family', type:'blue', red:'å®¶æ—ã‚„èº«è¿‘ãªäººã¨ä¸€ç·’ã«éã”ã—ãŸã„ãƒ»ã¤ãªãŒã‚Šã‚’ä¿ã¡ãŸã„', keys:[/å®¶æ—|å¤«|å¦»|å¨˜|æ¯å­|å­«|å‹äºº|è¿‘æ‰€|åŒå±…|ä¸€ç·’/]},
    {id:'Services', type:'blue', red:'ä»Šã®æ”¯æ´ï¼ˆè¨ªå•ãƒ»é€šæ‰€ç­‰ï¼‰ã®ãƒªã‚ºãƒ ã‚’ä¿ã¡ãŸã„', keys:[/ãƒ‡ã‚¤|é€šæ‰€|è¨ªå•|ãƒ˜ãƒ«ãƒ‘|çœ‹è­·|ãƒªãƒ|ã‚±ã‚¢ãƒãƒ|ã‚·ãƒ§ãƒ¼ãƒˆ|ã‚µãƒ¼ãƒ“ã‚¹|æ–½è¨­/]},
    {id:'Devices', type:'blue', red:'æ…£ã‚ŒãŸç”¨å…·ãƒ»ã‚„ã‚Šæ–¹ã‚’å¤‰ãˆãŸããªã„', keys:[/æ–|çœ¼é¡|è»Šæ¤…å­|ç´™ãƒ‘ãƒ³ãƒ„|ã‚ªãƒ ãƒ„|ãƒ™ãƒƒãƒ‰|æ‰‹ã™ã‚Š|ã‚¹ãƒ­ãƒ¼ãƒ—|è£œè´å™¨/]},
    {id:'BlueSchedule', type:'blue', red:'ä»Šã®é »åº¦ãƒ»ãƒšãƒ¼ã‚¹ãŒåˆã£ã¦ã„ã‚‹', keys:[/é€±|æœˆ|å›|æ›œæ—¥|æ¯/]},
    {id:'Pain', type:'green', red:'ç—›ã¿ã‚’é¿ã‘ãŸã„', keys:[/ç—›|ç–¼ç—›/]},
    {id:'Sleep', type:'green', red:'å¤œã¯é™ã‹ã«ä¼‘ã¿ãŸã„', keys:[/ä¸çœ |çœ ã‚Œ|ç¡çœ |å¤œé–“è¦šé†’/]},
    {id:'Fatigue', type:'green', red:'ç–²ã‚Œã‚’ãŸã‚ãŸããªã„', keys:[/ç–²ã‚Œ|æ˜“ç–²åŠ´|ã ã‚‹/]},
    {id:'Swallow', type:'green', red:'ã‚€ã›ã‚’æ¸›ã‚‰ã—ãŸã„', keys:[/ã‚€ã›|åš¥ä¸‹|é£²ã¿è¾¼ã¿/]},
    {id:'Sensory', type:'green', red:'é™ã‹ãªç’°å¢ƒã‚’å¥½ã¿ã€æ€¥ãªå¤‰åŒ–ã¯é¿ã‘ãŸã„', keys:[/éæ•|é©š|å¤§ãã„éŸ³|é¨’|çœ©|å…‰/]}
  ];
  function scoreCandidates(items){
    const ev=themes.map(th=>({theme:th,y:[],b:[],g:[],all:[]})); items.forEach(it=>{
      themes.forEach((th,idx)=>{ if(th.keys.some(re=>re.test(it.text))){ ev[idx].all.push(it); if(it.color==='é»„')ev[idx].y.push(it); if(it.color==='é’')ev[idx].b.push(it); if(it.color==='ç·‘')ev[idx].g.push(it);} });
    });
    const consist=b=>b.all.length>=4?3:b.all.length>=2?2:b.all.length>=1?1:0;
    const penalty=(id,b)=>Math.min(3, b.all.filter(it=>/(ã§ããªã„|é›£ã—ã„|æ‹’å¦|ä¸­æ­¢)/.test(it.text)).length);
    const cands=[]; ev.forEach(b=>{ const n=b.y.length+b.b.length+b.g.length; if(!n) return; const s=3*b.y.length+2*b.b.length+1*b.g.length+consist(b)-penalty(b.theme.id,b); cands.push({id:b.theme.id,red:b.theme.red,score:s,grade:s>=8?'A':s>=5?'B':'C',all:b.all,adopt:'none'}); });
    cands.sort((a,b)=>b.score-a.score); return cands;
  }
  function renderCandidates(cands){
    const wrap=document.getElementById('candidates'); wrap.innerHTML='';
    if(!cands.length){ wrap.innerHTML='<div class="small muted">ï¼ˆè©²å½“ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸï¼‰</div>'; btnPersona.disabled=true; return; }
    cands.forEach((c,idx)=>{
      const card=document.createElement('div'); card.className='card';
      card.innerHTML=`
        <div class="flex"><div><strong>å€™è£œP</strong>ï¼š${escapeHtml(c.red)}</div><div class="right small">ä¿¡é ¼åº¦ï¼š<strong>${c.grade}</strong>ï¼ˆ${c.score}ï¼‰</div></div>
        <div class="small muted" style="margin:8px 0 4px;">æ ¹æ‹ ï¼ˆé’ãƒ»é»„ãƒ»ç·‘ï¼šè¡Œç•ªå·ï¼‹åŸæ–‡ï¼‰</div>
        <ul class="small">${c.all.slice(0,8).map(it=>`<li>[${it.color||'âˆ’'} #${it.idx}] ${escapeHtml(it.text)}</li>`).join('')}${c.all.length>8?`<li class="muted">â€¦ä»– ${c.all.length-8} ä»¶</li>`:''}</ul>
        <div class="small muted" style="margin-top:4px;">æ³¨è¨˜ï¼šæ„æ€è¡¨æ˜ãŒé›£ã—ã„å ´åˆã¯ã€Œæœ€å–„ã®åˆ©ç›Šã€åŸå‰‡ã«åŸºã¥ãæ¨å®šã§ã™ã€‚å®¶æ—ãƒ»è·å“¡ã®æ‰€è¦‹ã§ç¢ºèªã—ã¦ãã ã•ã„ã€‚</div>
        <div class="flex" style="margin-top:8px;">
          <label><input type="radio" name="cand-${idx}" value="adopt"> æ¡ç”¨</label>
          <label><input type="radio" name="cand-${idx}" value="hold" checked> ä¿ç•™</label>
          <label><input type="radio" name="cand-${idx}" value="drop"> æ£„å´</label>
        </div>`;
      wrap.appendChild(card);
      card.querySelectorAll(`input[name=cand-${idx}]`).forEach(r=> r.addEventListener('change',()=>{
        c.adopt=r.value; btnPersona.disabled=!(window._cands||[]).some(x=>x.adopt==='adopt');
      }));
    });
  }
  function makePersonaText(adopted, items){
    const name=(document.getElementById('u-name').value || 'ã”æœ¬äºº');
    const pick=(arr,c,n=3)=>arr.filter(x=>x.color===c).slice(0,n).map(x=>x.text);
    const redsTxt = adopted.map(c=>`ã€Œ${c.red}ã€`).join('ã€') || 'ç”Ÿæ´»ã®å¸Œæœ›';
    const b=pick(items,'é’'), y=pick(items,'é»„'), g=pick(items,'ç·‘');
    const s1=`${name}ã¯ã€${redsTxt}ã‚’å¤§åˆ‡ã«ã—ã¦æš®ã‚‰ã—ã¦ã„ã‚‹ã€‚`;
    const s2=b.length?`ç’°å¢ƒé¢ã§ã¯ã€${b.join('ï¼')} ãªã©ãŒè¦‹ã‚‰ã‚Œã‚‹ã€‚`:'';
    const s3=y.length?`ã§ãã‚‹ã“ã¨ï¼ˆé‚è¡Œï¼‰ã§ã¯ã€${y.join('ï¼')} ãªã©ãŒã‚ã‚‹ã€‚`:'';
    const s4=g.length?`ã‹ã‚‰ã ã®è¦³å¯Ÿã§ã¯ã€${g.join('ï¼')} ãªã©ãŒæŒ™ãŒã£ã¦ã„ã‚‹ã€‚`:'';
    const s5=`ã“ã‚Œã‚‰ã‚’è¸ã¾ãˆã€æ¨å®šREDã¯ã€Œæœ€å–„ã®åˆ©ç›Šã€åŸå‰‡ã‚’æ˜è¨˜ã—ã€å®¶æ—ãƒ»è·å“¡ã®æ‰€è¦‹ã§ç¢ºèªã—ãªãŒã‚‰æ”¯æ´æ–¹é‡ã‚’æ•´ãˆã‚‹ã€‚`;
    return [s1,s2,s3,s4,s5].filter(Boolean).join('');
  }

  /* ---------- ç”»é¢ãƒœã‚¿ãƒ³ï¼šã‚¤ãƒ™ãƒ³ãƒˆæŸã­ï¼ˆå‹•ä½œå®‰å®šåŒ–ï¼‰ ---------- */
  btnAdd.addEventListener('click', ()=>{ addRow(''); updateAll(); });
  btnAutoMissing.addEventListener('click', ()=> autoDetectMissing());
  btnClear.addEventListener('click', ()=>{ rowsEl.innerHTML=''; updateAll(); });
  btnCsv.addEventListener('click', ()=> downloadCSV(collect()) );
  btnGoEstimate.addEventListener('click', ()=>{
    const items = collect();
    estimateWrap.style.display='block';
    window._cands = scoreCandidates(items);
    renderCandidates(window._cands);
    btnPersona.disabled = !window._cands.some(x=>x.adopt==='adopt');
    window.scrollTo({top:estimateWrap.offsetTop-10,behavior:'smooth'});
  });
  btnPersona.addEventListener('click', ()=>{
    const items = collect();
    const cands = (window._cands||[]).filter(x=>x.adopt==='adopt');
    personaWrap.style.display='block';
    personaEl.value = makePersonaText(cands, items);
    window.scrollTo({top:personaWrap.offsetTop-10,behavior:'smooth'});
  });
  btnCopy.addEventListener('click', ()=> navigator.clipboard.writeText(personaEl.value).then(()=>alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ')) );

  // CSVå‡ºåŠ›
  function downloadCSV(items){
    if(!items.length){ alert('å‡ºåŠ›ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
    const header = ['é€šã—ç•ªå·','å…¥åŠ›æƒ…å ±ï¼ˆåŸæ–‡ï¼‰','åˆ†é¡','è‰²','å‰¯æ¬¡ã‚¿ã‚°'];
    const lines = [header.join(',')];
    items.forEach(it=>{
      lines.push([it.idx, `"${it.text.replace(/"/g,'""')}"`, it.color||'æœªåˆ†é¡', it.color||'æœªåˆ†é¡', `"${(it.tags||[]).join('|')}"`].join(','));
    });
    const bom = new Uint8Array([0xEF,0xBB,0xBF]);
    const blob = new Blob([bom, lines.join('\r\n')], {type:'text/csv'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'å…¥åŠ›æƒ…å ±ä¸€è¦§ï¼ˆPEIPåˆ†é¡åˆ¥ï¼‰.csv';
    a.click();
  }

  // åˆæœŸè¡Œï¼ˆ15ï¼‰
  for(let i=0;i<15;i++) addRow('');
  updateAll();

  // ãƒ¢ãƒ¼ãƒ€ãƒ«å…¬é–‹APIï¼ˆå†…éƒ¨ç”¨ï¼‰
  function openModal(){ modal.style.display='flex'; modal.setAttribute('aria-hidden','false'); }
  function closeModal(){ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); }
  window._modal_open = openModal; window._modal_close = closeModal;

})();
</script>
</body>
</html>
